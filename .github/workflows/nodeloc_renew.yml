# NL_ACCOUNT 账号配置格式
# 用户名----密码
# 多账号配置（每行一个）
# user1----password1
# user2----password2
# user3----password3

name: NodeLoc 每日签到

on:
  schedule:
    - cron: '05 4 * * *'  # 每天北京时间 12:05 运行
  workflow_dispatch:
    inputs:
      debug:
        description: '调试模式'
        required: false
        default: 'false'
        type: boolean

jobs:
  checkin:
    name: 执行签到
    runs-on: ubuntu-latest
    steps:
      - name: 拉取代码
        uses: actions/checkout@v4

      - name: 配置Python环境
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: 安装Chrome浏览器
        id: setup-chrome
        uses: browser-actions/setup-chrome@v1
        with:
          chrome-version: 131

      - name: 安装Python依赖
        run: pip install undetected-chromedriver selenium requests

      - name: 创建截图目录
        run: mkdir -p /tmp/screenshots

      - name: 执行签到脚本
        env:
          NL_ACCOUNT: ${{ secrets.NL_ACCOUNT }}
          CHROME_PATH: ${{ steps.setup-chrome.outputs.chrome-path }}
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
        run: python nodeloc/main.py

#      - name: 上传调试截图
#        if: always()
#        uses: actions/upload-artifact@v4
#        with:
#          name: debug-screenshots
#          path: /tmp/screenshots/
#          retention-days: 3
#          if-no-files-found: ignore

      - name: 清理工作流记录
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          delete_workflow_pattern: ${{ github.workflow }}
          retain_days: 0
          keep_minimum_runs: 3
