name: Zampto 自动续期

on:
  schedule:
    - cron: '00 4 * * *'  # 每天北京时间 12:00 运行
  workflow_dispatch:

jobs:
  renew:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      actions: write
    concurrency:
      group: zampto-renew
      cancel-in-progress: false

    steps:
      - uses: actions/checkout@v4

      - name: 设置 Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: 安装依赖
        run: |
          sudo apt-get update && sudo apt-get install -y xvfb unzip
          pip install seleniumbase>=4.25.0 pyvirtualdisplay>=3.0 requests>=2.31.0

      - name: 安装并启动代理
        env:
          VLESS_URL: ${{ secrets.VLESS_URL }}
        run: |
          wget -q https://github.com/XTLS/Xray-core/releases/latest/download/Xray-linux-64.zip
          unzip -q Xray-linux-64.zip -d xray && chmod +x xray/xray
          
          python3 << 'PYEOF'
          import os, sys, json
          from urllib.parse import parse_qs, unquote

          url = os.environ.get("VLESS_URL", "").strip()
          if not url or not url.startswith("vless://"):
              print("[ERROR] 无效的 VLESS_URL"); sys.exit(1)

          url = url[8:]
          if "#" in url: url = url.rsplit("#", 1)[0]
          uuid, rest = url.split("@", 1)
          host_port, params_str = rest.split("?", 1) if "?" in rest else (rest, "")
          address, port = (host_port.rsplit(":", 1) if ":" in host_port else (host_port, "443"))
          params = parse_qs(params_str)

          config = {
              "log": {"loglevel": "none"},
              "inbounds": [
                  {"port": 10808, "listen": "127.0.0.1", "protocol": "socks", "settings": {"udp": True}},
                  {"port": 10809, "listen": "127.0.0.1", "protocol": "http"}
              ],
              "outbounds": [{
                  "protocol": "vless",
                  "settings": {"vnext": [{"address": address, "port": int(port), "users": [{"id": uuid, "encryption": "none"}]}]},
                  "streamSettings": {
                      "network": params.get("type", ["tcp"])[0],
                      "security": params.get("security", ["none"])[0],
                      **({"tlsSettings": {"serverName": params.get("sni", [address])[0], "fingerprint": params.get("fp", ["chrome"])[0]}} if params.get("security", ["none"])[0] == "tls" else {}),
                      **({"wsSettings": {"path": unquote(params.get("path", ["/"])[0]), "headers": {"Host": params.get("host", [address])[0]}}} if params.get("type", ["tcp"])[0] == "ws" else {})
                  }
              }]
          }
          with open("xray_config.json", "w") as f: json.dump(config, f)
          print("[INFO] 代理配置已生成")
          PYEOF
          
          ./xray/xray run -c xray_config.json > /dev/null 2>&1 &
          sleep 5
          
          # 测试代理（隐藏 IP）
          if curl -x socks5://127.0.0.1:10808 -s --max-time 15 https://api.ipify.org > /dev/null 2>&1; then
            echo "[INFO] ✅ 代理连接正常"
          else
            echo "[ERROR] ❌ 代理连接失败"
            exit 1
          fi

      - name: 执行续期
        env:
          ZAMPTO_ACCOUNT: ${{ secrets.ZAMPTO_ACCOUNT }}
          TG_BOT_TOKEN: ${{ secrets.TG_BOT_TOKEN }}
          TG_CHAT_ID: ${{ secrets.TG_CHAT_ID }}
          PROXY_SOCKS5: "socks5://127.0.0.1:10808"
        run: python scripts/zampto_renew.py

#      - name: 上传截图
#        uses: actions/upload-artifact@v4
#        if: always()
#        with:
#          name: screenshots-${{ github.run_number }}
#          path: output/screenshots/
#          retention-days: 3

      - name: 清理旧运行
        uses: Mattraks/delete-workflow-runs@v2
        with:
          token: ${{ github.token }}
          repository: ${{ github.repository }}
          delete_workflow_pattern: ${{ github.workflow }}
          retain_days: 0
          keep_minimum_runs: 3
