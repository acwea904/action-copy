#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import os
import time
import asyncio
import aiohttp
import base64
import random
import re
import subprocess
from datetime import datetime
from urllib.parse import unquote

from seleniumbase import SB

try:
    from nacl import encoding, public
    NACL_AVAILABLE = True
except ImportError:
    NACL_AVAILABLE = False

BASE_URL = "https://hub.weirdhost.xyz/server/"
DOMAIN = "hub.weirdhost.xyz"


# ============================================================
# å·¥å…·å‡½æ•°
# ============================================================
def parse_weirdhost_cookie(cookie_str):
    if not cookie_str:
        return (None, None)
    cookie_str = cookie_str.strip()
    if "=" in cookie_str:
        parts = cookie_str.split("=", 1)
        if len(parts) == 2:
            return (parts[0].strip(), unquote(parts[1].strip()))
    return (None, None)


def build_server_url(server_id):
    if not server_id:
        return None
    server_id = server_id.strip()
    return server_id if server_id.startswith("http") else f"{BASE_URL}{server_id}"


def calculate_remaining_time(expiry_str):
    try:
        for fmt in ["%Y-%m-%d %H:%M:%S", "%Y-%m-%d"]:
            try:
                expiry_dt = datetime.strptime(expiry_str.strip(), fmt)
                diff = expiry_dt - datetime.now()
                if diff.total_seconds() < 0:
                    return "âš ï¸ å·²è¿‡æœŸ"
                days = diff.days
                hours = diff.seconds // 3600
                minutes = (diff.seconds % 3600) // 60
                parts = []
                if days > 0:
                    parts.append(f"{days}å¤©")
                if hours > 0:
                    parts.append(f"{hours}å°æ—¶")
                if minutes > 0 and days == 0:
                    parts.append(f"{minutes}åˆ†é’Ÿ")
                return " ".join(parts) if parts else "ä¸åˆ°1åˆ†é’Ÿ"
            except ValueError:
                continue
        return "æ— æ³•è§£æ"
    except:
        return "è®¡ç®—å¤±è´¥"


def parse_expiry_to_datetime(expiry_str):
    if not expiry_str or expiry_str == "Unknown":
        return None
    for fmt in ["%Y-%m-%d %H:%M:%S", "%Y-%m-%d"]:
        try:
            return datetime.strptime(expiry_str.strip(), fmt)
        except ValueError:
            continue
    return None


def random_delay(min_sec=0.5, max_sec=2.0):
    time.sleep(random.uniform(min_sec, max_sec))


# ============================================================
# Telegram
# ============================================================
async def tg_notify(message):
    token = os.environ.get("TG_BOT_TOKEN")
    chat_id = os.environ.get("TG_CHAT_ID")
    if not token or not chat_id:
        return
    async with aiohttp.ClientSession() as session:
        try:
            await session.post(
                f"https://api.telegram.org/bot{token}/sendMessage",
                json={"chat_id": chat_id, "text": message, "parse_mode": "HTML"}
            )
        except Exception as e:
            print(f"[TG] å‘é€å¤±è´¥: {e}")


async def tg_notify_photo(photo_path, caption=""):
    token = os.environ.get("TG_BOT_TOKEN")
    chat_id = os.environ.get("TG_CHAT_ID")
    if not token or not chat_id or not os.path.exists(photo_path):
        return
    async with aiohttp.ClientSession() as session:
        try:
            with open(photo_path, "rb") as f:
                data = aiohttp.FormData()
                data.add_field("chat_id", chat_id)
                data.add_field("photo", f, filename=os.path.basename(photo_path))
                data.add_field("caption", caption)
                data.add_field("parse_mode", "HTML")
                await session.post(f"https://api.telegram.org/bot{token}/sendPhoto", data=data)
        except Exception as e:
            print(f"[TG] å›¾ç‰‡å‘é€å¤±è´¥: {e}")


def sync_tg_notify(message):
    asyncio.run(tg_notify(message))


def sync_tg_notify_photo(photo_path, caption=""):
    asyncio.run(tg_notify_photo(photo_path, caption))


# ============================================================
# GitHub Secrets
# ============================================================
def encrypt_secret(public_key, secret_value):
    pk = public.PublicKey(public_key.encode("utf-8"), encoding.Base64Encoder())
    sealed_box = public.SealedBox(pk)
    encrypted = sealed_box.encrypt(secret_value.encode("utf-8"))
    return base64.b64encode(encrypted).decode("utf-8")


async def update_github_secret(secret_name, secret_value):
    repo_token = os.environ.get("REPO_TOKEN", "").strip()
    repository = os.environ.get("GITHUB_REPOSITORY", "").strip()
    if not repo_token or not repository or not NACL_AVAILABLE:
        return False
    headers = {
        "Accept": "application/vnd.github+json",
        "Authorization": f"Bearer {repo_token}",
        "X-GitHub-Api-Version": "2022-11-28",
    }
    async with aiohttp.ClientSession() as session:
        try:
            pk_url = f"https://api.github.com/repos/{repository}/actions/secrets/public-key"
            async with session.get(pk_url, headers=headers) as resp:
                if resp.status != 200:
                    return False
                pk_data = await resp.json()
            encrypted_value = encrypt_secret(pk_data["key"], secret_value)
            secret_url = f"https://api.github.com/repos/{repository}/actions/secrets/{secret_name}"
            async with session.put(secret_url, headers=headers, json={
                "encrypted_value": encrypted_value, "key_id": pk_data["key_id"]
            }) as resp:
                return resp.status in (201, 204)
        except:
            return False


# ============================================================
# é¡µé¢è§£æ
# ============================================================
def get_expiry_from_page(sb):
    """ä»é¡µé¢è·å–åˆ°æœŸæ—¶é—´"""
    try:
        page_text = sb.get_page_source()
        match = re.search(r'ìœ í†µê¸°í•œ\s*(\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2})', page_text)
        if match:
            return match.group(1).strip()
        match = re.search(r'(\d{4}-\d{2}-\d{2}\s+\d{2}:\d{2}:\d{2})', page_text)
        if match:
            return match.group(1).strip()
        return "Unknown"
    except:
        return "Unknown"


def is_logged_in(sb):
    """æ£€æŸ¥æ˜¯å¦å·²ç™»å½•"""
    try:
        url = sb.get_current_url()
        if "/login" in url or "/auth" in url:
            return False
        if get_expiry_from_page(sb) != "Unknown":
            return True
        if sb.is_element_present("//button//span[contains(text(), 'ì‹œê°„ì¶”ê°€')]"):
            return True
        return False
    except:
        return False


# ============================================================
# Turnstile å¤„ç† (æ ¸å¿ƒ)
# ============================================================

# ä¿®å¤å¼¹çª—æ ·å¼çš„ JS - ç¡®ä¿ Turnstile å®Œå…¨å¯è§
EXPAND_POPUP_JS = """
(function() {
    // æ‰¾åˆ°åŒ…å« cf-turnstile-response çš„å¼¹çª—å®¹å™¨
    var turnstileInput = document.querySelector('input[name="cf-turnstile-response"]');
    if (!turnstileInput) return 'no turnstile input';
  
    // å‘ä¸Šéå†æ‰¾åˆ°å¼¹çª—å®¹å™¨å¹¶ä¿®å¤æ ·å¼
    var el = turnstileInput;
    for (var i = 0; i < 20; i++) {
        el = el.parentElement;
        if (!el) break;
      
        // ä¿®å¤ overflow
        var style = window.getComputedStyle(el);
        if (style.overflow === 'hidden' || style.overflowX === 'hidden' || style.overflowY === 'hidden') {
            el.style.overflow = 'visible';
        }
      
        // ç¡®ä¿å®½åº¦è¶³å¤Ÿ
        el.style.minWidth = 'max-content';
    }
  
    // æ‰¾åˆ°å¹¶ä¿®å¤ Turnstile å®¹å™¨ (sc-fKFyDc ç±»)
    var turnstileContainers = document.querySelectorAll('[class*="sc-fKFyDc"], [class*="nwOmR"]');
    turnstileContainers.forEach(function(container) {
        container.style.overflow = 'visible';
        container.style.width = '300px';
        container.style.minWidth = '300px';
        container.style.height = '65px';
    });
  
    // æ‰¾åˆ°æ‰€æœ‰ iframe å¹¶ç¡®ä¿å¯è§
    var iframes = document.querySelectorAll('iframe');
    iframes.forEach(function(iframe) {
        if (iframe.src && iframe.src.includes('challenges.cloudflare.com')) {
            iframe.style.width = '300px';
            iframe.style.height = '65px';
            iframe.style.minWidth = '300px';
            iframe.style.visibility = 'visible';
            iframe.style.opacity = '1';
        }
    });
  
    return 'done';
})();
"""


def find_turnstile_iframe(sb):
    """æŸ¥æ‰¾ Turnstile iframe - å¤šç§æ–¹æ³•"""
    # æ–¹æ³•1: é€šè¿‡ src åŒ…å« challenges.cloudflare.com
    try:
        iframes = sb.find_elements("css selector", "iframe[src*='challenges.cloudflare.com']")
        if iframes:
            return iframes[0]
    except:
        pass
  
    # æ–¹æ³•2: é€šè¿‡ src åŒ…å« turnstile
    try:
        iframes = sb.find_elements("css selector", "iframe[src*='turnstile']")
        if iframes:
            return iframes[0]
    except:
        pass
  
    # æ–¹æ³•3: æŸ¥æ‰¾æ‰€æœ‰ iframeï¼Œæ£€æŸ¥æ˜¯å¦åœ¨å¼¹çª—å†…
    try:
        iframes = sb.find_elements("css selector", "iframe")
        for iframe in iframes:
            src = iframe.get_attribute("src") or ""
            if "cloudflare" in src or "turnstile" in src:
                return iframe
    except:
        pass
  
    return None


def check_turnstile_exists(sb):
    """æ£€æŸ¥é¡µé¢æ˜¯å¦æœ‰ Turnstile (é€šè¿‡ hidden input)"""
    try:
        return sb.execute_script("""
            return document.querySelector('input[name="cf-turnstile-response"]') !== null;
        """)
    except:
        return False


def check_turnstile_solved(sb):
    """æ£€æŸ¥ Turnstile æ˜¯å¦å·²é€šè¿‡ (hidden input æœ‰å€¼)"""
    try:
        return sb.execute_script("""
            var input = document.querySelector('input[name="cf-turnstile-response"]');
            return input && input.value && input.value.length > 20;
        """)
    except:
        return False


def get_turnstile_checkbox_coords(sb):
    """è·å– Turnstile checkbox çš„åæ ‡"""
    try:
        # å…ˆå°è¯•é€šè¿‡ iframe
        coords = sb.execute_script("""
            var iframes = document.querySelectorAll('iframe');
            for (var i = 0; i < iframes.length; i++) {
                var src = iframes[i].src || '';
                if (src.includes('cloudflare') || src.includes('turnstile')) {
                    var rect = iframes[i].getBoundingClientRect();
                    if (rect.width > 0 && rect.height > 0) {
                        return {
                            x: rect.x,
                            y: rect.y,
                            width: rect.width,
                            height: rect.height,
                            // checkbox åœ¨ iframe å·¦ä¾§çº¦ 30px å¤„
                            click_x: Math.round(rect.x + 30),
                            click_y: Math.round(rect.y + rect.height / 2)
                        };
                    }
                }
            }
          
            // å¤‡ç”¨: é€šè¿‡ turnstile input çš„çˆ¶å®¹å™¨ä¼°ç®—ä½ç½®
            var input = document.querySelector('input[name="cf-turnstile-response"]');
            if (input) {
                var container = input.parentElement;
                for (var j = 0; j < 5; j++) {
                    if (!container) break;
                    var rect = container.getBoundingClientRect();
                    if (rect.width > 100 && rect.height > 30) {
                        return {
                            x: rect.x,
                            y: rect.y,
                            width: rect.width,
                            height: rect.height,
                            click_x: Math.round(rect.x + 30),
                            click_y: Math.round(rect.y + rect.height / 2)
                        };
                    }
                    container = container.parentElement;
                }
            }
          
            return null;
        """)
        return coords
    except:
        return None


def xdotool_click(x, y):
    """ä½¿ç”¨ xdotool è¿›è¡Œç‰©ç†ç‚¹å‡»"""
    try:
        subprocess.run(["xdotool", "mousemove", "--sync", str(int(x)), str(int(y))], 
                      check=True, timeout=5)
        time.sleep(0.1)
        subprocess.run(["xdotool", "click", "1"], check=True, timeout=5)
        return True
    except Exception as e:
        print(f"[!] xdotool ç‚¹å‡»å¤±è´¥: {e}")
        return False


def click_turnstile_with_xdotool(sb):
    """ä½¿ç”¨ xdotool ç‚¹å‡» Turnstile checkbox"""
    coords = get_turnstile_checkbox_coords(sb)
    if not coords:
        print("[!] æ— æ³•è·å– Turnstile åæ ‡")
        return False
  
    print(f"[*] Turnstile ä½ç½®: ({coords['x']:.0f}, {coords['y']:.0f}) "
          f"{coords['width']:.0f}x{coords['height']:.0f}")
  
    # è®¡ç®—å±å¹•ç»å¯¹åæ ‡
    try:
        window_info = sb.execute_script("""
            return {
                screenX: window.screenX || 0,
                screenY: window.screenY || 0,
                outerHeight: window.outerHeight,
                innerHeight: window.innerHeight
            };
        """)
      
        chrome_bar_height = window_info["outerHeight"] - window_info["innerHeight"]
        abs_x = coords["click_x"] + window_info["screenX"]
        abs_y = coords["click_y"] + window_info["screenY"] + chrome_bar_height
      
        print(f"[*] ç‚¹å‡»åæ ‡: ({abs_x:.0f}, {abs_y:.0f})")
        return xdotool_click(abs_x, abs_y)
    except Exception as e:
        print(f"[!] åæ ‡è®¡ç®—å¤±è´¥: {e}")
        return False


def click_turnstile_with_js(sb):
    """ä½¿ç”¨ JS æ¨¡æ‹Ÿç‚¹å‡» Turnstile"""
    try:
        result = sb.execute_script("""
            var iframes = document.querySelectorAll('iframe');
            for (var i = 0; i < iframes.length; i++) {
                var src = iframes[i].src || '';
                if (src.includes('cloudflare') || src.includes('turnstile')) {
                    // åˆ›å»ºå¹¶è§¦å‘ç‚¹å‡»äº‹ä»¶
                    var rect = iframes[i].getBoundingClientRect();
                    var clickX = rect.x + 30;
                    var clickY = rect.y + rect.height / 2;
                  
                    var clickEvent = new MouseEvent('click', {
                        view: window,
                        bubbles: true,
                        cancelable: true,
                        clientX: clickX,
                        clientY: clickY
                    });
                  
                    iframes[i].dispatchEvent(clickEvent);
                    return 'clicked iframe';
                }
            }
            return 'no iframe found';
        """)
        print(f"[*] JS ç‚¹å‡»ç»“æœ: {result}")
        return True
    except Exception as e:
        print(f"[!] JS ç‚¹å‡»å¤±è´¥: {e}")
        return False


def click_turnstile_with_selenium(sb):
    """ä½¿ç”¨ Selenium ActionChains ç‚¹å‡»"""
    try:
        from selenium.webdriver.common.action_chains import ActionChains
      
        iframe = find_turnstile_iframe(sb)
        if iframe:
            # ç‚¹å‡» iframe å·¦ä¾§ (checkbox ä½ç½®)
            actions = ActionChains(sb.driver)
            # ç§»åŠ¨åˆ° iframe å·¦ä¾§ 30px å¤„
            actions.move_to_element_with_offset(iframe, -100, 0).click().perform()
            print("[+] Selenium ActionChains ç‚¹å‡»å®Œæˆ")
            return True
    except Exception as e:
        print(f"[!] Selenium ç‚¹å‡»å¤±è´¥: {e}")
    return False


def click_turnstile_checkbox(sb):
    """ç‚¹å‡» Turnstile checkbox - å°è¯•å¤šç§æ–¹æ³•"""
  
    # æ–¹æ³•1: xdotool ç‰©ç†ç‚¹å‡» (æœ€å¯é )
    print("[*] å°è¯• xdotool ç‚¹å‡»...")
    if click_turnstile_with_xdotool(sb):
        return True
  
    # æ–¹æ³•2: uc_gui_click_captcha
    print("[*] å°è¯• uc_gui_click_captcha...")
    try:
        sb.uc_gui_click_captcha()
        print("[+] uc_gui_click_captcha å®Œæˆ")
        return True
    except Exception as e:
        print(f"[!] uc_gui_click_captcha å¤±è´¥: {e}")
  
    # æ–¹æ³•3: Selenium ActionChains
    print("[*] å°è¯• Selenium ActionChains...")
    if click_turnstile_with_selenium(sb):
        return True
  
    return False


# ============================================================
# ç»“æœæ£€æµ‹
# ============================================================

def check_success_popup(sb):
    """æ£€æŸ¥æ˜¯å¦å‡ºç°æˆåŠŸå¼¹çª—"""
    try:
        # æ£€æŸ¥ MessageBox ä¸­çš„ Success
        if sb.is_element_present("//span[contains(@class, 'title') and contains(text(), 'Success')]"):
            return True
        # æ£€æŸ¥ç»¿è‰²æˆåŠŸå›¾æ ‡ + ì„±ê³µ
        if sb.is_element_present("//*[contains(text(), 'ì„±ê³µ')]"):
            page = sb.get_page_source()
            if "successfully renew" in page.lower():
                return True
        return False
    except:
        return False


def check_cooldown_popup(sb):
    """æ£€æŸ¥æ˜¯å¦å‡ºç°å†·å´æœŸå¼¹çª—"""
    try:
        cooldown_texts = [
            "ì•„ì§ ì—°ì¥ì„ í• ìˆ˜ì—†ì–´ìš”",
            "ì•„ì§ ì„œë²„ë¥¼ ê°±ì‹ í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤",
            "ë‚¨ì€ ì‹œê°„ì´ ë” ì¤„ì–´ë“¤ ë•Œê¹Œì§€"
        ]
        page = sb.get_page_source()
        for text in cooldown_texts:
            if text in page:
                return True
        # æ£€æŸ¥ Error MessageBox
        if sb.is_element_present("//span[contains(@class, 'title') and contains(text(), 'Error')]"):
            return True
        return False
    except:
        return False


def click_next_button(sb):
    """ç‚¹å‡» NEXT æŒ‰é’®å…³é—­ç»“æœå¼¹çª—"""
    try:
        # ç²¾ç¡®åŒ¹é… NEXT æŒ‰é’®
        next_selectors = [
            "//button[contains(text(), 'NEXT')]",
            "//button[contains(text(), 'Next')]",
            "//button//span[contains(text(), 'NEXT')]",
            "//button//span[contains(text(), 'Next')]",
        ]
        for sel in next_selectors:
            if sb.is_element_visible(sel):
                sb.click(sel)
                print("[+] å·²ç‚¹å‡» NEXT æŒ‰é’®")
                return True
    except:
        pass
    return False


def click_popup_submit_button(sb):
    """ç‚¹å‡»å¼¹çª—å†…çš„ ì‹œê°„ì¶”ê°€ æäº¤æŒ‰é’®"""
    try:
        # æŸ¥æ‰¾å¼¹çª—å†…çš„ ì‹œê°„ì¶”ê°€ æŒ‰é’® (ä¸æ˜¯ä¾§æ çš„)
        # å¼¹çª—å†…çš„æŒ‰é’®åœ¨ RenewBox2 å®¹å™¨å†…
        buttons = sb.find_elements("css selector", "button")
      
        for btn in buttons:
            try:
                text = btn.text.strip()
                if "ì‹œê°„ì¶”ê°€" not in text:
                    continue
                if "DELETE" in text.upper():
                    continue
              
                # æ£€æŸ¥æŒ‰é’®ä½ç½® - å¼¹çª—æŒ‰é’®é€šå¸¸åœ¨é¡µé¢ä¸­é—´
                rect = sb.execute_script(
                    "var r = arguments[0].getBoundingClientRect(); "
                    "return {x: r.x, y: r.y, w: r.width, h: r.height};", 
                    btn
                )
              
                # ä¾§æ æŒ‰é’® x < 200, å¼¹çª—æŒ‰é’® x > 200
                if rect and rect.get("x", 0) > 180:
                    print(f"[*] æ‰¾åˆ°å¼¹çª—å†…æŒ‰é’®: x={rect['x']:.0f}")
                    btn.click()
                    print("[+] å·²ç‚¹å‡»å¼¹çª—å†… ì‹œê°„ì¶”ê°€ æŒ‰é’®")
                    return True
            except:
                continue
      
        print("[!] æœªæ‰¾åˆ°å¼¹çª—å†…çš„ ì‹œê°„ì¶”ê°€ æŒ‰é’®")
        return False
    except Exception as e:
        print(f"[!] ç‚¹å‡»æäº¤æŒ‰é’®å¤±è´¥: {e}")
        return False


# ============================================================
# ä¸»æµç¨‹
# ============================================================

def handle_renewal_popup(sb, timeout=90):
    """
    å¤„ç†ç»­æœŸå¼¹çª—çš„å®Œæ•´æµç¨‹:
    1. ç­‰å¾…å¼¹çª—å‡ºç°
    2. æ£€æµ‹å¹¶ç‚¹å‡» Turnstile
    3. ç­‰å¾… Turnstile é€šè¿‡
    4. ç‚¹å‡»å¼¹çª—å†… ì‹œê°„ì¶”ê°€ æŒ‰é’®
    5. ç­‰å¾…ç»“æœ (Success/Error)
    6. ç‚¹å‡» NEXT å…³é—­
    """
    start_time = time.time()
  
    # ========== é˜¶æ®µ1: ç­‰å¾…å¼¹çª—å’Œ Turnstile ==========
    print("\n[é˜¶æ®µ1] ç­‰å¾…å¼¹çª—å’Œ Turnstile...")
  
    turnstile_ready = False
    for _ in range(20):  # æœ€å¤šç­‰å¾… 20 ç§’
        if check_turnstile_exists(sb):
            turnstile_ready = True
            print("[+] æ£€æµ‹åˆ° Turnstile")
            break
      
        # æ£€æŸ¥æ˜¯å¦ç›´æ¥æ˜¾ç¤ºå†·å´æœŸ
        if check_cooldown_popup(sb):
            print("[*] æ£€æµ‹åˆ°å†·å´æœŸå¼¹çª—")
            return {"status": "cooldown"}
      
        time.sleep(1)
  
    if not turnstile_ready:
        print("[!] æœªæ£€æµ‹åˆ° Turnstileï¼Œå¯èƒ½å¼¹çª—æœªæ­£ç¡®æ‰“å¼€")
        sb.save_screenshot("no_turnstile.png")
        return {"status": "error", "message": "æœªæ£€æµ‹åˆ° Turnstile"}
  
    # ========== é˜¶æ®µ2: ä¿®å¤å¼¹çª—æ ·å¼ ==========
    print("\n[é˜¶æ®µ2] ä¿®å¤å¼¹çª—æ ·å¼...")
  
    for _ in range(3):
        result = sb.execute_script(EXPAND_POPUP_JS)
        print(f"[*] æ ·å¼ä¿®å¤: {result}")
        time.sleep(0.5)
  
    sb.save_screenshot("popup_fixed.png")
  
    # ========== é˜¶æ®µ3: ç‚¹å‡» Turnstile ==========
    print("\n[é˜¶æ®µ3] ç‚¹å‡» Turnstile checkbox...")
  
    turnstile_solved = False
  
    for attempt in range(6):
        print(f"\n  --- å°è¯• {attempt + 1}/6 ---")
      
        # æ£€æŸ¥æ˜¯å¦å·²é€šè¿‡
        if check_turnstile_solved(sb):
            print("[+] Turnstile å·²é€šè¿‡!")
            turnstile_solved = True
            break
      
        # ä¿®å¤æ ·å¼
        sb.execute_script(EXPAND_POPUP_JS)
        time.sleep(0.3)
      
        # ç‚¹å‡»
        click_turnstile_checkbox(sb)
      
        # ç­‰å¾…éªŒè¯
        print("[*] ç­‰å¾… Turnstile éªŒè¯...")
        for _ in range(8):
            time.sleep(0.5)
            if check_turnstile_solved(sb):
                print("[+] Turnstile å·²é€šè¿‡!")
                turnstile_solved = True
                break
      
        if turnstile_solved:
            break
      
        sb.save_screenshot(f"turnstile_attempt_{attempt}.png")
  
    if not turnstile_solved:
        print("[!] Turnstile æœªèƒ½é€šè¿‡éªŒè¯")
        # ç»§ç»­å°è¯•æäº¤ï¼Œä¹Ÿè®¸å·²ç»é€šè¿‡äº†
  
    # ========== é˜¶æ®µ4: ç‚¹å‡»å¼¹çª—å†… ì‹œê°„ì¶”ê°€ æŒ‰é’® ==========
    print("\n[é˜¶æ®µ4] ç‚¹å‡»å¼¹çª—å†…æäº¤æŒ‰é’®...")
  
    time.sleep(1)
    sb.save_screenshot("before_submit.png")
  
    if not click_popup_submit_button(sb):
        print("[!] æœªèƒ½ç‚¹å‡»æäº¤æŒ‰é’®")
        return {"status": "error", "message": "æœªèƒ½ç‚¹å‡»æäº¤æŒ‰é’®"}
  
    # ========== é˜¶æ®µ5: ç­‰å¾…ç»“æœ ==========
    print("\n[é˜¶æ®µ5] ç­‰å¾…ç»“æœ...")
  
    result_timeout = 30
    result_start = time.time()
  
    while time.time() - result_start < result_timeout:
        # æ£€æŸ¥æˆåŠŸ
        if check_success_popup(sb):
            print("[+] æ£€æµ‹åˆ°æˆåŠŸå¼¹çª—!")
            sb.save_screenshot("success.png")
            time.sleep(1)
            click_next_button(sb)
            return {"status": "success"}
      
        # æ£€æŸ¥å†·å´æœŸ
        if check_cooldown_popup(sb):
            print("[*] æ£€æµ‹åˆ°å†·å´æœŸå¼¹çª—")
            sb.save_screenshot("cooldown.png")
            time.sleep(1)
            click_next_button(sb)
            return {"status": "cooldown"}
      
        time.sleep(1)
  
    print("[!] ç­‰å¾…ç»“æœè¶…æ—¶")
    sb.save_screenshot("timeout.png")
    return {"status": "timeout"}


def add_server_time():
    """ä¸»å‡½æ•°"""
    weirdhost_cookie = os.environ.get("WEIRDHOST_COOKIE", "").strip()
    weirdhost_id = os.environ.get("WEIRDHOST_ID", "").strip()

    cookie_name, cookie_value = parse_weirdhost_cookie(weirdhost_cookie)
    server_url = build_server_url(weirdhost_id)

    if not cookie_name or not cookie_value:
        sync_tg_notify("ğŸ <b>Weirdhost</b>\n\nâŒ WEIRDHOST_COOKIE æœªè®¾ç½®æˆ–æ ¼å¼é”™è¯¯")
        return
    if not server_url:
        sync_tg_notify("ğŸ <b>Weirdhost</b>\n\nâŒ WEIRDHOST_ID æœªè®¾ç½®")
        return

    print("=" * 60)
    print("Weirdhost è‡ªåŠ¨ç»­æœŸ v8")
    print("=" * 60)
    print(f"[*] Cookie: {cookie_name}")
    print(f"[*] URL: {server_url}")
    print("=" * 60)

    original_expiry = "Unknown"

    try:
        with SB(uc=True, test=True, locale="ko", headless=False) as sb:
            print("\n[*] æµè§ˆå™¨å·²å¯åŠ¨")

            # ===== æ­¥éª¤1: è®¾ç½® Cookie =====
            print("\n[æ­¥éª¤1] è®¾ç½® Cookie")
            sb.uc_open_with_reconnect(f"https://{DOMAIN}", reconnect_time=3)
            time.sleep(2)
            sb.add_cookie({
                "name": cookie_name, "value": cookie_value,
                "domain": DOMAIN, "path": "/"
            })
            print("[+] Cookie å·²è®¾ç½®")

            # ===== æ­¥éª¤2: è®¿é—®æœåŠ¡å™¨é¡µé¢ =====
            print("\n[æ­¥éª¤2] è®¿é—®æœåŠ¡å™¨é¡µé¢")
            sb.uc_open_with_reconnect(server_url, reconnect_time=5)
            time.sleep(3)

            if not is_logged_in(sb):
                sb.add_cookie({
                    "name": cookie_name, "value": cookie_value,
                    "domain": DOMAIN, "path": "/"
                })
                sb.uc_open_with_reconnect(server_url, reconnect_time=5)
                time.sleep(3)

            if not is_logged_in(sb):
                sb.save_screenshot("login_failed.png")
                sync_tg_notify_photo("login_failed.png",
                    "ğŸ <b>Weirdhost</b>\n\nâŒ Cookie å¤±æ•ˆï¼Œè¯·æ›´æ–°")
                return

            print("[+] ç™»å½•æˆåŠŸ")

            original_expiry = get_expiry_from_page(sb)
            remaining = calculate_remaining_time(original_expiry)
            print(f"[*] åˆ°æœŸ: {original_expiry}")
            print(f"[*] å‰©ä½™: {remaining}")
            sb.save_screenshot("before_renew.png")

            # ===== æ­¥éª¤3: ç‚¹å‡»ä¾§æ ç»­æœŸæŒ‰é’® =====
            print("\n[æ­¥éª¤3] ç‚¹å‡»ä¾§æ ç»­æœŸæŒ‰é’®")
            random_delay(1.0, 2.0)

            # ä¾§æ çš„ ì‹œê°„ì¶”ê°€ æŒ‰é’®
            sidebar_btn_xpath = "//button//span[contains(text(), 'ì‹œê°„ì¶”ê°€')]/parent::button"
            if not sb.is_element_present(sidebar_btn_xpath):
                sidebar_btn_xpath = "//button[contains(., 'ì‹œê°„ì¶”ê°€')]"
            
            if not sb.is_element_present(sidebar_btn_xpath):
                sb.save_screenshot("no_button.png")
                sync_tg_notify_photo("no_button.png",
                    f"ğŸ <b>Weirdhost</b>\n\nâš ï¸ æœªæ‰¾åˆ°ç»­æœŸæŒ‰é’®\nğŸ“… åˆ°æœŸ: {original_expiry}")
                return

            sb.click(sidebar_btn_xpath)
            print("[+] å·²ç‚¹å‡»ä¾§æ æŒ‰é’®ï¼Œç­‰å¾…å¼¹çª—...")
            time.sleep(3)
            sb.save_screenshot("popup_opened.png")

            # ===== æ­¥éª¤4: å¤„ç†ç»­æœŸå¼¹çª— =====
            print("\n[æ­¥éª¤4] å¤„ç†ç»­æœŸå¼¹çª—")
            result = handle_renewal_popup(sb, timeout=90)
            print(f"\n[*] å¤„ç†ç»“æœ: {result}")

            # ===== æ­¥éª¤5: éªŒè¯ç»­æœŸç»“æœ =====
            print("\n[æ­¥éª¤5] éªŒè¯ç»­æœŸç»“æœ")
            time.sleep(3)
            
            # åˆ·æ–°é¡µé¢è·å–æœ€æ–°åˆ°æœŸæ—¶é—´
            sb.uc_open_with_reconnect(server_url, reconnect_time=3)
            time.sleep(3)
            
            new_expiry = get_expiry_from_page(sb)
            new_remaining = calculate_remaining_time(new_expiry)
            sb.save_screenshot("final_state.png")

            print(f"[*] åŸåˆ°æœŸ: {original_expiry}")
            print(f"[*] æ–°åˆ°æœŸ: {new_expiry}")

            original_dt = parse_expiry_to_datetime(original_expiry)
            new_dt = parse_expiry_to_datetime(new_expiry)

            # æ ¹æ®ç»“æœå‘é€é€šçŸ¥
            if result["status"] == "cooldown":
                msg = (f"ğŸ <b>Weirdhost ç»­è®¢æŠ¥å‘Š</b>\n\n"
                       f"â„¹ï¸ å†·å´æœŸå†…ï¼Œæš‚æ—¶æ— æ³•ç»­æœŸ\n"
                       f"ğŸ“… åˆ°æœŸ: {original_expiry}\n"
                       f"â³ å‰©ä½™: {remaining}")
                sync_tg_notify(msg)
                return

            if original_dt and new_dt:
                if new_dt > original_dt:
                    diff_h = (new_dt - original_dt).total_seconds() / 3600
                    msg = (f"ğŸ <b>Weirdhost ç»­è®¢æŠ¥å‘Š</b>\n\n"
                           f"âœ… ç»­æœŸæˆåŠŸï¼\n"
                           f"ğŸ“… æ–°åˆ°æœŸ: {new_expiry}\n"
                           f"â³ å‰©ä½™: {new_remaining}\n"
                           f"ğŸ“ å»¶é•¿äº† {diff_h:.1f} å°æ—¶")
                    print(f"\n[+] æˆåŠŸï¼å»¶é•¿ {diff_h:.1f} å°æ—¶")
                    sync_tg_notify(msg)

                elif new_dt == original_dt:
                    msg = (f"ğŸ <b>Weirdhost ç»­è®¢æŠ¥å‘Š</b>\n\n"
                           f"âš ï¸ åˆ°æœŸæ—¶é—´æœªå˜åŒ–\n"
                           f"ğŸ“… åˆ°æœŸ: {original_expiry}\n"
                           f"â³ å‰©ä½™: {remaining}\n"
                           f"ğŸ“ å¯èƒ½åŸå› : Turnstile æœªé€šè¿‡ / å†·å´æœŸå†…")
                    print("\n[*] æ—¶é—´æœªå˜åŒ–")
                    sync_tg_notify_photo("final_state.png", msg)

                else:
                    msg = (f"ğŸ <b>Weirdhost ç»­è®¢æŠ¥å‘Š</b>\n\n"
                           f"âš ï¸ æ—¶é—´å¼‚å¸¸\n"
                           f"ğŸ“… åŸåˆ°æœŸ: {original_expiry}\n"
                           f"ğŸ“… æ–°åˆ°æœŸ: {new_expiry}")
                    sync_tg_notify_photo("final_state.png", msg)

            elif new_expiry != "Unknown":
                msg = (f"ğŸ <b>Weirdhost ç»­è®¢æŠ¥å‘Š</b>\n\n"
                       f"âœ… ç»­æœŸå®Œæˆ\n"
                       f"ğŸ“… åˆ°æœŸ: {new_expiry}\n"
                       f"â³ å‰©ä½™: {new_remaining}")
                sync_tg_notify(msg)

            else:
                msg = (f"ğŸ <b>Weirdhost ç»­è®¢æŠ¥å‘Š</b>\n\n"
                       f"âš ï¸ æ— æ³•è·å–åˆ°æœŸæ—¶é—´\n"
                       f"ğŸ“… åŸåˆ°æœŸ: {original_expiry}\n"
                       f"ğŸ“ çŠ¶æ€: {result.get('status', 'unknown')}")
                sync_tg_notify_photo("final_state.png", msg)

            # ===== æ­¥éª¤6: æ›´æ–° Cookie (å¦‚æœæœ‰å˜åŒ–) =====
            try:
                cookies = sb.get_cookies()
                for cookie in cookies:
                    if cookie.get("name", "").startswith("remember_web"):
                        new_val = cookie.get("value", "")
                        if new_val and new_val != cookie_value:
                            new_cookie_str = f"{cookie['name']}={new_val}"
                            print(f"\n[*] æ£€æµ‹åˆ°æ–° Cookie")
                            if asyncio.run(update_github_secret("WEIRDHOST_COOKIE", new_cookie_str)):
                                print("[+] Cookie å·²è‡ªåŠ¨æ›´æ–°åˆ° GitHub Secrets")
                            break
            except Exception as e:
                print(f"[!] Cookie æ›´æ–°æ£€æŸ¥å¤±è´¥: {e}")

    except Exception as e:
        import traceback
        error_msg = f"ğŸ <b>Weirdhost</b>\n\nâŒ è„šæœ¬å¼‚å¸¸\n\n<code>{repr(e)}</code>"
        print(f"\n[!] å¼‚å¸¸: {repr(e)}")
        traceback.print_exc()

        # å‘é€æœ€è¿‘çš„æˆªå›¾
        screenshots = [
            "final_state.png", "timeout.png", "cooldown.png", "success.png",
            "before_submit.png", "popup_fixed.png", "popup_opened.png", 
            "before_renew.png", "no_turnstile.png"
        ]
        for img in screenshots:
            if os.path.exists(img):
                sync_tg_notify_photo(img, error_msg)
                break
        else:
            sync_tg_notify(error_msg)


if __name__ == "__main__":
    add_server_time()
